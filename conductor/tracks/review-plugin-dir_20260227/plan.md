# Implementation Plan: Pass Plugin Dir to PR Review Sessions

**Track ID:** review-plugin-dir_20260227
**Spec:** [spec.md](./spec.md)
**Created:** 2026-02-27
**Status:** [~] In Progress

## Overview

Thread `--plugin-dir` support through the session host, then use it in the PR review flow to conditionally clone `gen-ai-agents` and make the `code-review` plugin available.

## Phase 1: Session Host Plugin Dir Support

Wire `pluginDirs` from ProcessManager through to the `claude` CLI args in session-host.

### Tasks

- [x] Task 1.1: Add `pluginDirs?: string[]` to `HostConfig` in `session-host.ts` and append `--plugin-dir` args to the `claude` spawn call
- [x] Task 1.2: Extend `ProcessManager.send()` options to accept `pluginDirs?: string[]`, pass through to `connectOrSpawn` and into `hostConfig`
- [x] Task 1.3: Add tests for pluginDirs flowing through to session host config

### Verification

- [x] Existing tests still pass (126/126)
- [x] New tests verify pluginDirs are included in hostConfig when provided (tested via Phase 2 integration tests)

## Phase 2: Conditional Plugin Cloning in PR Review

Detect whether the target repo has the code-review plugin; if not, clone gen-ai-agents and pass the plugin dir.

### Tasks

- [x] Task 2.1: Add `hasCodeReviewPlugin(dir: string)` function in `github-pr-review.ts` — checks for the plugin in the cloned repo (e.g. `plugins/code-review/.claude-plugin/plugin.json` or `.claude/plugins.json` referencing it)
- [x] Task 2.2: Add `clonePluginRepo(pr: PrInfo, signal?: AbortSignal)` function — shallow-clones `stone-payments/gen-ai-agents` to a sibling temp dir, returns the path to `plugins/code-review`
- [x] Task 2.3: Update `processGitHubPrReview` to: detect plugin → conditionally clone → pass `pluginDirs` to `processManager.send` → clean up both temp dirs
- [x] Task 2.4: Add tests for `hasCodeReviewPlugin` (found / not found cases)
- [x] Task 2.5: Add tests for conditional cloning flow (plugin present → no clone, plugin missing → clone + pluginDirs passed)

### Verification

- [x] All tests pass (132/132)
- [x] Both temp directories cleaned up in all scenarios (success, failure, abort)

## Final Verification

- [ ] All acceptance criteria met
- [ ] Tests passing
- [ ] Re-trigger review on PR #171 to validate end-to-end

---

_Generated by Conductor. Tasks will be marked [~] in progress and [x] complete._
