# Implementation Plan: PR Review CI/CD Integration

**Track ID:** pr-review-ci_20260226
**Spec:** [spec.md](./spec.md)
**Created:** 2026-02-26
**Status:** [x] Complete

## Overview

Add a `POST /github-pr-review` endpoint to the HTTP adapter that accepts a PR URL, validates it against a repo allowlist, clones the repo to a temp directory, and spawns a one-shot Claude Code session inside it with a system prompt instructing it to review the PR using the project's own skills or `gh` CLI. Handles failures by commenting on the PR and cancels in-progress reviews when the same PR is triggered again.

## Phase 1: Endpoint, Validation, and Allowlist

Add the new route with input validation and repo allowlist enforcement.

### Tasks

- [x] Task 1.1: Add `POST /github-pr-review` route in `src/adapters/http.ts` that accepts `{ "pr_url": "..." }` and returns `{ "status": "queued" }` immediately
- [x] Task 1.2: Implement PR URL parser to extract owner, repo, and PR number from `https://github.com/{owner}/{repo}/pull/{number}`
- [x] Task 1.3: Add repo allowlist configuration (env var `BARECLAW_REVIEW_REPOS`, comma-separated, e.g. `owner/repo,owner/repo2`)
- [x] Task 1.3.1: Update `.env.example` with `BARECLAW_REVIEW_REPOS` template
- [x] Task 1.4: Validate the parsed repo against the allowlist; return 403 if not allowed
- [x] Task 1.5: Write tests for URL parsing, allowlist validation, and error responses

### Verification

- [x] Endpoint returns 200 for allowed repos, 403 for disallowed repos, 400 for invalid input

## Phase 2: Repo Cloning and Session Spawning

Clone the repo and spawn a Claude session inside it with a review-focused system prompt.

### Tasks

- [x] Task 2.1: Implement async `processGitHubPrReview(prUrl, processManager)` function that clones the repo to `/tmp/bareclaw-review-{owner}-{repo}-{pr}`
- [x] Task 2.2: Craft the system prompt that instructs Claude to: check out the PR branch, look for a review skill in `.claude/commands/`, and if found use it — otherwise fall back to `gh pr diff` + `gh pr review`
- [x] Task 2.3: Spawn a one-shot Claude session using `ProcessManager.send()` with a unique channel key (e.g. `github-pr-{owner}-{repo}-{pr}`) and the cloned repo as cwd
- [x] Task 2.4: Handle cleanup — remove the temp directory after the review completes

### Verification

- [x] A cloned repo appears in `/tmp/`, Claude session starts, and temp dir is cleaned up after completion

## Phase 3: Failure Handling

Handle Claude session failures gracefully.

### Tasks

- [x] Task 3.1: Catch errors from `ProcessManager.send()` and any clone/spawn failures
- [x] Task 3.2: On failure, post a comment on the PR via `gh pr comment` indicating the automated review failed (include error summary)
- [x] Task 3.3: Ensure temp directory cleanup runs regardless of success or failure
- [x] Task 3.4: Write tests for failure scenarios (invalid repo, clone failure, session crash)

### Verification

- [x] A failed review results in a PR comment explaining the failure and temp dir is cleaned up

## Phase 4: Concurrent Review Cancellation

When a new review is triggered for the same PR, cancel the in-progress one and start fresh.

### Tasks

- [x] Task 4.1: Track active reviews in a `Map<channelKey, { abort: AbortController, tempDir: string }>`
- [x] Task 4.2: On new request for the same PR: kill the existing session (via ProcessManager channel teardown), clean up the old temp dir, then start fresh
- [x] Task 4.3: Write tests for cancel-and-restart behavior

### Verification

- [x] A second request for the same PR cancels the first, cleans up, and starts a new review

## Phase 5: GitHub Actions Workflow

Provide a reusable GitHub Actions workflow snippet.

### Tasks

- [x] Task 5.1: Create a sample GitHub Actions workflow file (e.g. `examples/github-pr-review.yml`) that triggers on `pull_request` opened/synchronize and curls `POST /github-pr-review`
- [x] Task 5.2: Document the setup requirements (BAREclaw host URL, auth token, `gh` CLI auth on the BAREclaw host)

### Verification

- [x] Example workflow is valid YAML and documents all required configuration

## Final Verification

- [x] All acceptance criteria met
- [x] Tests passing
- [x] Allowed repos enforced, disallowed repos rejected
- [x] Failed reviews post a comment on the PR
- [x] Concurrent reviews for the same PR cancel-and-restart correctly
- [x] Example workflow provided

---

_Generated by Conductor. Tasks will be marked [~] in progress and [x] complete._
